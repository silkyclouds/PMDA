---
description: PMDA – chemins serveur 192.168.3.2, Plex Saturday, déploiement beta. OBLIGATION rebuild+deploy après tout changement.
globs: docs/**/*.md,*.md,Dockerfile,pmda.py,frontend/**/*
alwaysApply: true
---

# OBLIGATION : rebuild + redéploiement après tout changement

**Cette règle est impérative.** Dès que tu modifies du code applicatif PMDA (pmda.py, frontend/, Dockerfile, requirements, config déploiement), tu DOIS enchaîner rebuild + push + déploiement sur le serveur, sans demander à l'utilisateur.

1. **Build + push** (à la racine du repo) :  
   `docker buildx build --platform linux/amd64,linux/arm64 -t meaning/pmda:beta --push .`
2. **Déploiement** (SSH root@192.168.3.2) :  
   `docker pull meaning/pmda:beta` puis arrêt/suppression de `PMDA_WEBUI`, puis `docker run` (voir bloc ci-dessous).

Ne jamais proposer "veux-tu que je rebuild ?" — exécuter le cycle complet à chaque fois.

---

# Serveur de test PMDA (192.168.3.2) – chemins à ne pas oublier

## Plex Media Server (Plex-Media-Server-Saturday)

- **Conteneur** : `Plex-Media-Server-Saturday`, image `plexinc/pms-docker`.
- **Base de données Plex** (dossier à monter en `/database` dans PMDA) :
  - Hôte : `/mnt/cache/plex-saturday/config/Library/Application Support/Plex Media Server/Plug-in Support/Databases`
  - Ce dossier contient `com.plexapp.plugins.library.db`.
- **Config Plex** : `/mnt/cache/plex-saturday/config` → `/config` dans le conteneur Plex.
- **Data Plex** : `/mnt/cache/plex-saturday/data` → `/data`.
- **Musique** : `/mnt/user/MURRAY/Music/...` (matched, unmatched, compilations).

## PMDA – conteneur minimal (wizard-first)

- **Nom conteneur** : `PMDA_WEBUI`.
- **Image** : `meaning/pmda:beta` (ou `meaning/pmda:latest`).
- **Montages obligatoires** (pas de `-e` requis pour premier run) :
  1. **Config** : `/mnt/user/appdata/PMDA_fresh` → `/config` (config "neuve" pour test) ou `/mnt/user/appdata/PMDA` pour config existante.
  2. **Database Plex** : `/mnt/cache/plex-saturday/config/Library/Application Support/Plex Media Server/Plug-in Support/Databases` → `/database:ro`
  3. **Dupes** : `/mnt/user/appdata/PMDA_dupes` → `/dupes`.
  4. **Musique (OBLIGATOIRE)** : `/mnt/user/MURRAY/Music` → `/music:ro` (parent folder : matched, unmatched, compilations). Sans ce bind, « Verify bindings » échoue (fichiers introuvables dans le conteneur).
- **Port** : `-p 5005:5005`.
- **URL** : http://192.168.3.2:5005

## Commande Docker minimale (copier-coller serveur)

```bash
docker stop PMDA_WEBUI 2>/dev/null || true
docker rm PMDA_WEBUI 2>/dev/null || true
docker run -d --name PMDA_WEBUI \
  --restart unless-stopped \
  -v "/mnt/user/appdata/PMDA_fresh:/config:rw" \
  -v "/mnt/cache/plex-saturday/config/Library/Application Support/Plex Media Server/Plug-in Support/Databases:/database:ro" \
  -v "/mnt/user/appdata/PMDA_dupes:/dupes:rw" \
  -v "/mnt/user/MURRAY/Music:/music:ro" \
  -p 5005:5005 \
  meaning/pmda:beta
```
